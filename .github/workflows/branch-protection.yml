name: Apply Branch Protection

on:
  repository_dispatch:
    types: [apply-branch-protection]
  schedule:
    - cron: '0 * * * *'  # runs hourly to catch any new repos
  workflow_dispatch:

jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Apply branch protection to all org repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_ADMIN_TOKEN }}
          script: |
            const org = context.repo.owner;
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org,
              per_page: 100,
            });

            const protection = {
              required_status_checks: null,
              enforce_admins: false,
              required_pull_request_reviews: {
                required_approving_review_count: 1,
                dismiss_stale_reviews: true,
              },
              restrictions: null,
              allow_force_pushes: false,
              allow_deletions: false,
            };

            for (const repo of repos) {
              const branch = repo.default_branch;
              try {
                await github.rest.repos.updateBranchProtection({
                  owner: org,
                  repo: repo.name,
                  branch,
                  ...protection,
                });
                console.log(`✅ Protected ${repo.name}/${branch}`);
              } catch (err) {
                console.log(`⚠️ Skipped ${repo.name}/${branch}: ${err.message}`);
              }
            }
